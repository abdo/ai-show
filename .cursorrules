# AI Show - Project Rules & Architecture

## Project Overview

**AI Show** is a full-stack TypeScript application that creates cinematic, AI-generated conversations from user situations.

**Two Modes:**
1. **Story Mode**: Cinematic re-enactment ("Show, Don't Tell")
2. **Conversation Mode**: Dynamic discussion/debate between friends

**Architecture:**
- **Frontend**: React 19 + TypeScript + Vite SPA
- **Backend**: Node.js + TypeScript (local), Bun + TypeScript (production on Railway)
- **AI Services**: Groq API (story generation), OpenAI TTS API (voice synthesis), Deepgram (voice chat)

---

## Tech Stack

### Frontend
- **Build**: Vite
- **Language**: TypeScript (strict mode)
- **UI**: React 19 (functional components only)
- **Routing**: React Router v7
- **Styling**: Plain CSS
- **Animation**: GSAP, OGL (WebGL)
- **HTTP**: Axios
- **Analytics**: PostHog (optional)

### Backend
- **Runtime**: Node.js (local dev), Bun (Railway deployment)
- **Language**: TypeScript
- **Server**: Express (Node.js), Bun.serve (Bun)
- **WebSocket**: ws package (Node.js), native WebSocket (Bun)
- **AI**: Groq API (`llama-3.3-70b-versatile`), OpenAI TTS (`gpt-4o-mini-tts`), Deepgram Voice Agent
- **HTTP**: Axios, CORS middleware

---

## Project Structure

```
ai-show/
├── src/                              # Frontend
│   ├── pages/
│   │   ├── LandingPage/             # Input + mode selection (/)
│   │   ├── TheatrePage/             # Show playback (/theatre)
│   │   └── ConversationPage/        # Voice chat (/conversation)
│   ├── components/
│   │   ├── ChromaGrid/              # 3D character grid
│   │   ├── ModeSwitch/              # Mode toggle
│   │   └── VolumeControl/           # Audio controls
│   ├── hooks/
│   │   ├── useShow.ts               # Story generation API call
│   │   └── useDeepgramVoice.ts      # Voice chat hook
│   ├── services/
│   │   ├── api.ts                   # Backend API client
│   │   └── apiUrl.ts                # Environment-aware URLs
│   └── constants/
│       └── demoData.ts              # Mock data for demo mode
│
├── server/                          # Backend
│   ├── server.ts                    # Main server (orchestrator)
│   ├── handlers/                    # Request handlers
│   │   ├── getShow/
│   │   │   ├── getShow.ts           # Story generation (Node.js)
│   │   │   └── getShow-bun.ts       # Story generation (Bun)
│   │   ├── talk/
│   │   │   ├── talk.ts              # Voice chat WebSocket (Node.js)
│   │   │   └── talk-bun.ts          # Voice chat WebSocket (Bun)
│   │   └── interview/
│   │       ├── interview.ts         # Interview WebSocket (Node.js)
│   │       └── interview-bun.ts     # Interview WebSocket (Bun)
│   └── .env                         # Backend environment variables
│
├── .env                             # Frontend env vars
└── package.json                     # Frontend dependencies
```

---

## Environment Configuration

### Frontend (`.env` in project root)
```env
VITE_POSTHOG_API_KEY=phc_...     # Optional analytics
```

**Usage**: Access via `import.meta.env.VITE_POSTHOG_API_KEY`

### Backend (`server/.env`)
```env
GROQ_API_KEY=gsk_...              # Required
OPENAI_TTS_API_KEY=sk-proj-...    # Required
DEEPGRAM_KEY=...                  # Required
PORT=3001                         # Optional, defaults to 3001
```

**Usage**: Loaded via `dotenv` in server files

---

## Key Features

### Mock Mode (Frontend)
**Purpose**: Demo mode that uses cached data from localStorage to avoid API calls during development/testing.

**How it works:**
1. When `mock` setting is enabled (via URL param or state), frontend uses `demoData.ts`
2. First API call stores response in localStorage (`ai-show-cache`)
3. Subsequent requests with `mock` enabled load from cache
4. Useful for frontend development without backend running

**Implementation**: `src/hooks/useShow.ts` checks for cached data when mock mode is active

### CORS Configuration
**Backend** (`server/server.ts`):
- Uses `cors` npm package with default settings for development
- Production origins handled by deployment platform
- Server must be accessible for browser requests

---

## Data Flow

### Story Generation
```
1. User Input (LandingPage)
   → Navigate to /theatre with { topic, mode, name }

2. TheatrePage (useShow hook)
   → Check if mock mode + cache exists → use cached data
   → Otherwise: POST to /getShow

3. Backend (server.ts delegates to handlers/getShow/getShow.ts)
   ├─ Validates request body
   ├─ generateStory()
   │  ├─ Groq API → characters + dialogue
   │  └─ Enrich: avatars, voices, colors
   ├─ generateVoices()
   │  ├─ Clean text (remove markdown/emojis)
   │  └─ OpenAI TTS → base64 audio
   └─ Return { story, audioMap }

4. Frontend
   └─ Sequential audio playback with character highlighting
```

### Voice Chat
```
1. User connects to /talk WebSocket (with optional prompt/greeting params)
2. Backend (server.ts delegates to handlers/talk/talk.ts)
   └─ Proxies to Deepgram Voice Agent with custom config
3. Real-time bidirectional audio streaming
4. Deepgram handles STT → LLM → TTS pipeline
```

### Interview Mode
```
1. User connects to /interview WebSocket with role parameter
   Example: ws://localhost:3001/interview?role=Software%20Engineer
2. Backend (server.ts delegates to handlers/interview/interview.ts)
   ├─ Validates role parameter (required)
   ├─ Calls Groq API (openai/gpt-oss-120b) to generate interviewer prompt
   │  └─ Meta-prompt creates Kevin Mccanly interviewer with 100 questions
   └─ Connects to Deepgram with generated prompt + custom greeting
3. Real-time interview conversation
4. Interviewer provides feedback at end
```

---

## Character System

**25 Standardized Roles** (defined in handlers):
- empathetic, analytical, provocateur, emotional, calm, assertive, skeptical, optimistic, cynical, nurturing, intense, playful, serious, wise, rebellious, mediator, challenger, supporter, observer, wildcard, curious, compassionate, humorous, sarcastic, thoughtful

**Voice Pools:**
- Male: onyx, ash
- Female: alloy, nova, shimmer, sage, coral

**Selection Logic**: Tracks used voices to avoid repetition within a single story

---

## Coding Standards

### TypeScript
- No `any` (use `unknown` or proper types)
- Explicit return types on functions
- Named exports preferred
- Single source of truth for types

### React (Frontend)
- Functional components only
- Hooks: useState, useEffect, useCallback, useMemo, useRef
- **Prefer reusable hooks**: Extract complex or reusable logic into custom hooks (e.g., `useDynamicallyZoomLargeScreens`) instead of polluting components.
- Co-locate CSS with components
- React Router v7 for navigation

### Backend
- **server.ts**: Lean orchestrator - only handles routing & HTTP responses
- **handlers/**: All business logic and validation
- Use `console.log` for logging (or add a logger library if needed)
- Error handling via thrown errors with descriptive messages

---

## Common Tasks

### Run Locally
```bash
npm run dev            # Both frontend + backend
```

Or separately:
```bash
# Terminal 1: Backend
cd server
npm run dev           # Runs on :3001

# Terminal 2: Frontend
npm run dev           # Runs on :5173
```

### Deploy Backend
Deployment is manual via Railway:
1. Copy content of `server/handlers/getShow/getShow-bun.ts` to Railway
2. Copy content of `server/handlers/talk/talk-bun.ts` to another Railway service
3. Set environment variables in Railway dashboard

### Modify AI Prompts
Edit `server/handlers/getShow/getShow.ts` (search for prompt constants)
- `storyGenerationPrompt(mode)` function
- Test both Story and Conversation modes
- Also update `server/handlers/getShow/getShow-bun.ts` to keep in sync

### Add New Character Role
1. Add to `roleDescriptions` in `server/handlers/getShow/getShow.ts`
2. Also update `server/handlers/getShow/getShow-bun.ts` to keep in sync
3. Types update automatically

### Customize Voice Chat
Edit `server/handlers/talk/talk.ts`:
- Modify `DEFAULT_PROMPT` or `DEFAULT_GREETING`
- Custom prompts can also be passed via URL query params
- Also update `server/handlers/talk/talk-bun.ts` to keep in sync

---

## Debugging

**Backend:**
- Port already in use: Change PORT in `server/.env`
- CORS errors: Check cors middleware in `server/server.ts`
- Module not found: Ensure imports use `./handlers/` path correctly
- API timeout: Check API keys and network

**Frontend:**
- Can't connect: Verify backend on `:3001` and `apiUrl.ts` URLs are correct
- Audio not playing: Check console for base64 errors
- WebSocket fails: Ensure using `wss://` for production (HTTPS sites)

**AI Issues:**
- Poor dialogue: Adjust prompts in `server/handlers/getShow/getShow.ts`
- Invalid JSON: Check Groq API logs
- Voice sounds wrong: Check tone extraction in text cleaner utility

---

**Last Updated**: December 2024

---

## SEO & Accessibility Guidelines

### Semantic HTML
- Use `<main>` for primary content
- Use `<header>`, `<footer>`, `<nav>`, `<aside>` for structural elements
- Use `<section>` or `<article>` instead of generic `<div>` where appropriate
- Ensure heading hierarchy (`h1` -> `h2` -> `h3`) is logical and sequential

### Accessibility (a11y)
- All interactive elements (buttons, links) MUST have accessible names:
  - Visible text content
  - `aria-label` for icon-only buttons
- Images MUST have descriptive `alt` text (or empty string if decorative)
- Use `aria-hidden="true"` for decorative icons/elements
- Ensure sufficient color contrast for text

### Meta Tags
- Maintain `description`, `keywords`, `author`, and `theme-color` in `index.html`
- Ensure Open Graph (`og:`) and Twitter Card (`twitter:`) tags are present and accurate
