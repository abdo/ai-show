# AI Show - Project Rules & Architecture

## Project Overview

**AI Show** is a full-stack TypeScript application that creates cinematic, AI-generated conversations from user situations.

**Two Modes:**
1. **Story Mode**: Cinematic re-enactment ("Show, Don't Tell")
2. **Conversation Mode**: Dynamic discussion/debate between friends

**Architecture:**
- **Frontend**: React 19 + TypeScript + Vite SPA
- **Backend**: Firebase Cloud Functions (Node.js 24)
- **AI Services**: Groq API (story generation) + OpenAI TTS API (voice synthesis)

---

## Tech Stack

### Frontend
- **Build**: Vite
- **Language**: TypeScript (strict mode)
- **UI**: React 19 (functional components only)
- **Routing**: React Router v7
- **Styling**: Plain CSS
- **Animation**: GSAP, OGL (WebGL)
- **HTTP**: Axios
- **Analytics**: PostHog (optional)

### Backend
- **Runtime**: Firebase Cloud Functions (Node.js 24)
- **Language**: TypeScript
- **AI**: Groq API (`llama-3.3-70b-versatile`), OpenAI TTS (`gpt-4o-mini-tts`)
- **HTTP**: Axios, CORS middleware

---

## Project Structure

```
ai-show/
├── src/                              # Frontend
│   ├── pages/
│   │   ├── LandingPage/             # Input + mode selection (/)
│   │   └── TheatrePage/             # Show playback (/theatre)
│   ├── components/
│   │   ├── ChromaGrid/              # 3D character grid
│   │   ├── ModeSwitch/              # Mode toggle
│   │   └── VolumeControl/           # Audio controls
│   ├── hooks/
│   │   └── useShow.ts               # API call + audio playback
│   ├── services/
│   │   └── api.ts                   # Backend API client
│   └── constants/
│       └── demoData.ts              # Mock data for demo mode
│
├── backend/functions/
│   └── src/
│       ├── index.ts                 # Function exports + CORS
│       ├── config.ts                # Environment config loader
│       ├── controllers/
│       │   └── showController.ts    # Request handler
│       ├── services/
│       │   ├── storyService.ts      # Story generation
│       │   └── voiceService.ts      # Voice synthesis
│       ├── constants/
│       │   ├── prompts.ts           # AI prompts
│       │   ├── theatreCharacters.ts # Roles + voices
│       │   └── avatarConstants.ts   # Avatar pools
│       ├── types/
│       │   └── index.ts             # Shared types
│       └── utils/
│           ├── AppError.ts          # Custom errors
│           └── textCleaner.ts       # TTS preprocessing
│
├── .env                             # Frontend env vars
└── backend/functions/.env           # Backend env vars
```

---

## Environment Configuration

### Frontend (`.env` in project root)
```env
VITE_POSTHOG_API_KEY=phc_...     # Optional analytics
```

**Usage**: Access via `import.meta.env.VITE_POSTHOG_API_KEY`

### Backend (`backend/functions/.env`)
```env
GROQ_API_KEY=gsk_...              # Required
OPENAI_TTS_API_KEY=sk-proj-...    # Required
```

**Usage**: Loaded via `src/config.ts` using `dotenv`

---

## Key Features

### Mock Mode (Frontend)
**Purpose**: Demo mode that uses cached data from localStorage to avoid API calls during development/testing.

**How it works:**
1. When `mock` setting is enabled (via URL param or state), frontend uses `demoData.ts`
2. First API call stores response in localStorage (`ai-show-cache`)
3. Subsequent requests with `mock` enabled load from cache
4. Useful for frontend development without backend running

**Implementation**: `src/hooks/useShow.ts` checks for cached data when mock mode is active

### CORS Configuration
**Backend** (`src/index.ts`):
- Allowed origins: `http://localhost:5173`, `https://ai-show.com`
- Uses `cors` npm package with explicit origin whitelist
- Cloud Run service must be public (unauthenticated) for browsers to access

---

## Data Flow

```
1. User Input (LandingPage)
   → Navigate to /theatre with { topic, mode, name }

2. TheatrePage (useShow hook)
   → Check if mock mode + cache exists → use cached data
   → Otherwise: POST to Firebase Function

3. Backend (getShow function)
   ├─ StoryService.generateStory()
   │  ├─ Groq API → characters + dialogue
   │  └─ Enrich: avatars, voices, colors
   ├─ VoiceService.generateVoices()
   │  ├─ Clean text (remove markdown/emojis)
   │  └─ OpenAI TTS → base64 audio
   └─ Return { story, audioMap }

4. Frontend
   └─ Sequential audio playback with character highlighting
```

---

## Character System

**20 Standardized Roles** (defined in `theatreCharacters.ts`):
- empathetic, analytical, provocateur, emotional, calm, assertive, skeptical, optimistic, cynical, nurturing, intense, playful, serious, wise, rebellious, mediator, challenger, supporter, observer, wildcard

**Voice Pools:**
- Male: onyx, ash
- Female: alloy, nova, shimmer, sage, coral

**Selection Logic**: Tracks used voices to avoid repetition within a single story

---

## Coding Standards

### TypeScript
- No `any` (use `unknown` or proper types)
- Explicit return types on functions
- Named exports preferred
- Single source of truth for types

### React (Frontend)
- Functional components only
- Hooks: useState, useEffect, useCallback, useMemo, useRef
- **Prefer reusable hooks**: Extract complex or reusable logic into custom hooks (e.g., `useDynamicScale`) instead of polluting components.
- Co-locate CSS with components
- React Router v7 for navigation

### Backend (Firebase Functions)
- Controllers: HTTP concerns (CORS, validation)
- Services: Business logic
- Use `firebase-functions/logger` not `console.log`
- Error handling via `AppError` class

---

## Common Tasks

### Run Locally
```bash
# Terminal 1: Backend
cd backend/functions
npm run serve          # Runs on :5000

# Terminal 2: Frontend
npm run dev            # Runs on :5173
```

### Deploy Backend
```bash
cd backend/functions
firebase deploy --only functions
```
Update `src/services/api.ts` with deployed URL.

### Modify AI Prompts
Edit `backend/functions/src/constants/prompts.ts`
- `storyGenerationPrompt(mode)` function
- Test both Story and Conversation modes

### Add New Character Role
1. Add to `roleDescriptions` in `backend/functions/src/constants/theatreCharacters.ts`
2. Types update automatically

---

## Debugging

**Backend:**
- "Cannot find module './config'": Ensure `backend/functions/src/config.ts` exists
- CORS errors: Check `src/index.ts` CORS middleware
- API timeout: Increase `timeoutSeconds` in function config

**Frontend:**
- Can't connect: Verify backend on `:5000` and `api.ts` URL is correct
- Audio not playing: Check console for base64 errors

**AI Issues:**
- Poor dialogue: Adjust `prompts.ts`
- Invalid JSON: Check Groq API logs

---

**Last Updated**: November 2024

---

## SEO & Accessibility Guidelines

### Semantic HTML
- Use `<main>` for primary content
- Use `<header>`, `<footer>`, `<nav>`, `<aside>` for structural elements
- Use `<section>` or `<article>` instead of generic `<div>` where appropriate
- Ensure heading hierarchy (`h1` -> `h2` -> `h3`) is logical and sequential

### Accessibility (a11y)
- All interactive elements (buttons, links) MUST have accessible names:
  - Visible text content
  - `aria-label` for icon-only buttons
- Images MUST have descriptive `alt` text (or empty string if decorative)
- Use `aria-hidden="true"` for decorative icons/elements
- Ensure sufficient color contrast for text

### Meta Tags
- Maintain `description`, `keywords`, `author`, and `theme-color` in `index.html`
- Ensure Open Graph (`og:`) and Twitter Card (`twitter:`) tags are present and accurate
