# AI Show - Project Rules & Architecture

## Project Overview

**AI Show** is a React + TypeScript web application that creates cinematic, AI-generated conversations from user situations. It uses:
- **Groq AI** (`llama-3.3-70b-versatile`) for generating dramatic character dialogues
- **OpenAI TTS** (`gpt-4o-mini-tts`) for realistic, persona-based voice generation
- **React 18 + Vite + React Router** for modern SPA development

The app generates 3-6 distinct characters with unique voices, personalities, and perspectives, then plays their conversation as an animated theatrical experience.

---

## Tech Stack

### Core
- **Build Tool**: Vite
- **Language**: TypeScript (strict mode)
- **UI Framework**: React 18 (functional components only)
- **Routing**: React Router v6
- **Styling**: Plain CSS (co-located with components)
- **Animation**: GSAP (for ChromaGrid spotlight effects)
- **HTTP Client**: Axios

### AI Services
- **Text Generation**: Groq API (`llama-3.3-70b-versatile`)
- **Voice Synthesis**: OpenAI TTS API (`gpt-4o-mini-tts`)

### Key Libraries
- `ogl` - WebGL graphics (for ChromaGrid)
- `gsap` - Smooth animations
- `react-router-dom` - Client-side routing

---

## Architecture

### File Structure

```
src/
‚îú‚îÄ‚îÄ pages/                       # Route pages
‚îÇ   ‚îú‚îÄ‚îÄ LandingPage/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LandingPage.tsx      # Hero + input (route: /)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ LandingPage.css
‚îÇ   ‚îî‚îÄ‚îÄ TheatrePage/
‚îÇ       ‚îú‚îÄ‚îÄ TheatrePage.tsx      # Theatre mode (route: /theatre)
‚îÇ       ‚îî‚îÄ‚îÄ TheatrePage.css
‚îú‚îÄ‚îÄ components/                   # Reusable UI components
‚îÇ   ‚îú‚îÄ‚îÄ ChromaGrid/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChromaGrid.tsx       # Interactive character grid
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ChromaGrid.css
‚îÇ   ‚îî‚îÄ‚îÄ VolumeControl/
‚îÇ       ‚îú‚îÄ‚îÄ VolumeControl.tsx    # Audio volume slider
‚îÇ       ‚îî‚îÄ‚îÄ VolumeControl.css
‚îú‚îÄ‚îÄ ui/                          # UI primitives
‚îÇ   ‚îî‚îÄ‚îÄ icons/                   # SVG icon components
‚îÇ       ‚îú‚îÄ‚îÄ DownloadIcon.tsx
‚îÇ       ‚îú‚îÄ‚îÄ ReplayIcon.tsx
‚îÇ       ‚îú‚îÄ‚îÄ PauseIcon.tsx
‚îÇ       ‚îî‚îÄ‚îÄ PlayIcon.tsx
‚îú‚îÄ‚îÄ hooks/                       # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ usePerspectives.ts       # Groq AI story generation
‚îÇ   ‚îî‚îÄ‚îÄ usePersonaVoices.ts      # OpenAI TTS voice management
‚îú‚îÄ‚îÄ constants/                   # Static configuration
‚îÇ   ‚îú‚îÄ‚îÄ theatreCharacters.ts     # Character roles & voice config
‚îÇ   ‚îú‚îÄ‚îÄ prompts.ts              # AI prompts & conversation dynamics
‚îÇ   ‚îî‚îÄ‚îÄ demoData.ts             # Fallback/mock story data
‚îú‚îÄ‚îÄ lib/                        # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ avatarConstants.ts      # Gender-specific avatar pools
‚îÇ   ‚îú‚îÄ‚îÄ textCleaner.ts         # Text sanitization for TTS
‚îÇ   ‚îî‚îÄ‚îÄ audioUtils.ts          # Audio processing utilities
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ theatre.webp           # Landing page background
‚îú‚îÄ‚îÄ keys.ignore.ts             # API keys (NEVER COMMIT!)
‚îú‚îÄ‚îÄ App.tsx                    # Router setup
‚îî‚îÄ‚îÄ main.tsx                   # Entry point
```

### Routing

```
/ (LandingPage)
  ‚Üí User enters situation
  ‚Üí Navigates to /theatre with state

/theatre (TheatrePage)
  ‚Üí Fetches story from Groq
  ‚Üí Generates voices from OpenAI
  ‚Üí Plays conversation
  ‚Üí Redirects to / if no topic
```

---

## Key Concepts

### 1. Story Generation Flow

1. User enters a situation on `/` (LandingPage)
2. Navigate to `/theatre` with `{ state: { topic } }`
3. `usePerspectives` sends to Groq AI with detailed prompt from `constants/prompts.ts`
4. AI returns 3-6 characters with:
   - Name, gender, role (from 20 standardized roles in `constants/theatreCharacters.ts`)
   - Border colors and gradients
   - 14-18 dialogue lines
5. Characters get:
   - Gender-appropriate avatars (from `lib/avatarConstants.ts`)
   - Gender-appropriate OpenAI voices (avoids repetition when possible)
   - Role-based TTS instructions (from `constants/theatreCharacters.ts`)

### 2. Voice System

**20 Standardized Roles** (defined in `constants/theatreCharacters.ts`):
- Single source of truth: `roleDescriptions` object
- Type and array derived from it: `CharacterRole`, `availableRoles`
- Roles: empathetic, analytical, provocateur, emotional, calm, assertive, skeptical, optimistic, cynical, nurturing, intense, playful, serious, wise, rebellious, mediator, challenger, supporter, observer, wildcard

Each role maps to:
- **Instructions** for OpenAI TTS (e.g., "raw, expressive, passionate")
- **Voice pool** by gender:
  - Males: onyx, ash, echo (3 voices)
  - Females: alloy, nova, shimmer, sage, coral (5 voices)

**Voice Selection Logic**:
- Tracks `usedVoices` Set per story generation
- Picks from unused voices first (to avoid repetition)
- Falls back to random if all voices exhausted
- Male characters: can repeat after 3 males
- Female characters: can repeat after 5 females

### 3. Text-to-Speech Pipeline

1. User clicks "Start the show"
2. Browser requests user interaction (autoplay policy bypass)
3. `usePersonaVoices` generates all voices in parallel:
   - Cleans text via `lib/textCleaner.ts` (removes markdown, emojis, stage directions)
   - Calls OpenAI TTS with role-based instructions
   - Converts response to base64 `data:audio/mp3` URI
4. Plays dialogue sequentially with 100ms gap between lines
5. First audio has 600ms delay to prevent cutoff
6. Highlights speaking character in ChromaGrid

### 4. Audio Features

- **Volume Control**: Real-time adjustment via `VolumeControl` component
- **Pause/Resume**: Toggle playback without losing position
- **Replay**: Restart conversation without re-fetching
- **Download**: Combine all audio into single WAV file

---

## Coding Standards

### TypeScript

- **No `any`** - use `unknown` or proper types
- **Explicit prop types** for all components
- **Named exports** preferred (except main component per file)
- **Type imports** when appropriate (`import type { ... }`)
- **Derive types from data** when possible (single source of truth)

Example:
```typescript
// Good: Derive type from constant
export const roleDescriptions = { ... } as const;
export type CharacterRole = keyof typeof roleDescriptions;

// Bad: Maintain separately
export type CharacterRole = "empathetic" | "analytical" | ...;
export const roles = ["empathetic", "analytical", ...];
```

### React Patterns

- **Functional components only** (no classes)
- **Hooks**: `useState`, `useEffect`, `useCallback`, `useMemo`, `useRef`
- **Custom hooks** for complex logic (data fetching, voice management)
- **Controlled components** for forms
- **React Router** for navigation (use `navigate()`, `useLocation()`)

### State Management

- **React hooks** for local state
- **React Router state** for page-to-page data passing
- **useMemo** for expensive computations
- **useCallback** for stable function references
- **useRef** for mutable values that don't trigger re-renders

### Async Patterns

Always handle:
- ‚úÖ Loading states (`isLoading`)
- ‚úÖ Error states (`error`)
- ‚úÖ Success states (`data`)
- ‚úÖ Cleanup (abort controllers, unmount flags)

Example:
```typescript
const [state, setState] = useState({ data: null, isLoading: false, error: null });

useEffect(() => {
  let isMounted = true;
  
  async function fetch() {
    setState(prev => ({ ...prev, isLoading: true }));
    try {
      const result = await apiCall();
      if (isMounted) setState({ data: result, isLoading: false, error: null });
    } catch (error) {
      if (isMounted) setState({ data: null, isLoading: false, error: error.message });
    }
  }
  
  fetch();
  return () => { isMounted = false; };
}, []);
```

### Styling

- **Plain CSS files** co-located with components
- **Component-scoped classes** (e.g., `.landing-page`, `.theatre-page`)
- **CSS custom properties** for theming (e.g., `--angle` for animations)
- **Responsive**: use `clamp()`, `vw`, media queries
- **Dark theme**: base is `#0a0a0a`, use rgba for overlays
- **Mobile-first**: mobile drawer for actions, desktop side buttons

### Performance

- **Lazy load** heavy components if needed
- **Memoize** expensive computations
- **Parallel API calls** when independent (e.g., voice generation uses `Promise.all`)
- **Avoid UI blocking**: set state immediately before async operations
- **Audio optimization**: pre-generate all voices before playback

### Organization

- **Single source of truth**: derive types/arrays from constants
- **Separation of concerns**:
  - `pages/` - route components
  - `components/` - reusable UI
  - `ui/` - primitives (icons, buttons)
  - `constants/` - static config
  - `hooks/` - business logic
  - `lib/` - utilities
- **Co-location**: keep component CSS with component file
- **Consistent structure**: each component in its own folder

---

## API Keys & Security

### Keys Location: `src/keys.ignore.ts`

```typescript
export const groqApiKey = "gsk_...";
export const openAiTTSApiKey = "sk-proj-...";
```

**Rules**:
- ‚úÖ Never commit `keys.ignore.ts` (in `.gitignore`)
- ‚úÖ Never log keys to console
- ‚úÖ Client-side keys only (no server secrets)
- ‚úÖ Use environment variables in production

---

## AI Configuration

### Groq Story Generation

**Prompt Location**: `src/constants/prompts.ts`
- `storyGenerationPrompt` - Full system prompt
- `conversationDynamics` - 20 narrative techniques

**Prompt Structure**:
1. **Mission**: Create gripping, emotionally charged conversation
2. **Character Depth**: Distinct styles, motivations, flaws
3. **Standardized Roles**: MUST use one of 20 roles (affects voice)
4. **Conversation Dynamics**: 20 narrative techniques (e.g., "bold opening", "heated exchange")
5. **Act Structure**: 
   - Act 1 (4-5 lines): Hook + establish characters
   - Act 2 (6-8 lines): Escalate conflict + reveal layers
   - Act 3 (4-5 lines): Climax + transformation
6. **Dialogue Craft**: Contractions, fragments, stage directions, natural cadence
7. **Forbidden**: Therapist-speak, tidy resolutions, exposition

**Output**: JSON with `characters[]` and `dialogue[]`

### OpenAI TTS Configuration

**Voice Config Location**: `src/constants/theatreCharacters.ts`
- `roleDescriptions` - Single source of truth for all roles
- `maleVoices` - Array of male voice IDs
- `femaleVoices` - Array of female voice IDs

Each role has concise instructions (e.g., "warm, understanding, slower speech" for empathetic). These are dynamically passed to `gpt-4o-mini-tts` to shape voice characteristics.

---

## Common Patterns

### Adding a New Character Role

1. Add to `roleDescriptions` in `src/constants/theatreCharacters.ts`
2. That's it! `CharacterRole` type and `availableRoles` array are auto-derived
3. Groq prompt is dynamically generated from the object

### Adding a New Voice

1. Verify voice is supported by OpenAI TTS
2. Add to `maleVoices` or `femaleVoices` in `src/constants/theatreCharacters.ts`
3. Test with `test-openai-voices.html` (standalone test page in root)

### Debugging Voice Issues

- Check console for `[Voice N] CharacterName (gender, role): voice=X, model=Y`
- Verify base64 audio URI is generated (`data:audio/mp3;base64,...`)
- Check browser autoplay policy (requires user interaction first)
- Inspect OpenAI API response status (401 = permissions, 429 = rate limit)

### Text Cleaning for TTS

Located in `src/lib/textCleaner.ts`:
- Removes markdown (`**bold**`, `_italic_`)
- Removes emojis (üé≠, ‚ù§Ô∏è, etc.)
- Removes stage directions (`[pauses]`, `[laughs]`)
- Preserves punctuation for natural pauses

---

## Testing

### Browser Testing
- Always test with user interaction (click to play)
- Test on Chrome, Firefox, Safari (autoplay policies differ)
- Test with network throttling (for loading states)

### Manual Test Scenarios
1. Generate story with 3 characters (all unique voices)
2. Generate story with 6 characters (some voice repetition expected)
3. Generate story with all male/all female characters
4. Test first audio cutoff fix (600ms delay)
5. Test character highlighting during speech
6. Test pause/resume/replay/download functionality
7. Test direct `/theatre` navigation (should redirect to `/`)

---

## Known Limitations

1. **Voice Repetition**: After 3 males or 5 females, voices will repeat
2. **Browser Autoplay**: First interaction required to unlock audio
3. **Rate Limits**: OpenAI TTS has rate limits (429 errors possible)
4. **Mobile**: Spotlight animation may be heavy on low-end devices
5. **State Loss**: Refreshing `/theatre` loses story (navigated via state, not URL)

---

## Development Workflow

### Starting Dev Server
```bash
npm install
npm run dev
```

### Building for Production
```bash
npm run build
npm run preview  # Test production build
```

### Code Quality
- Run linter before committing
- Fix all TypeScript errors (no `@ts-ignore`)
- Test in browser (not just CLI)
- Check responsive design (desktop + mobile)

---

## Troubleshooting

### "401 Unauthorized" from OpenAI
- API key missing or invalid permissions
- Ensure key has "model.request" scope

### "Audio cutoff at start"
- First audio needs 600ms delay (`isFirstAudio` flag)
- Check `playDialogue` in `usePersonaVoices.ts`

### "Characters don't highlight when speaking"
- `currentDialogueIndex` not updating
- Check `setCurrentDialogueIndex` in `playDialogue`

### "Redirected to home from /theatre"
- `/theatre` requires `location.state.topic` from navigation
- Direct URL access will redirect to `/`

### "Downloaded audio only plays in one ear"
- Fixed: `combineAudioBuffers` now handles mono/stereo correctly
- Check `lib/audioUtils.ts` for stereo conversion logic

---

## Important Files

| File | Purpose | Notes |
|------|---------|-------|
| `keys.ignore.ts` | API keys | Never commit |
| `constants/prompts.ts` | AI prompts | Carefully tuned |
| `constants/theatreCharacters.ts` | Role system | Single source of truth |
| `hooks/usePerspectives.ts` | Story fetching | Handles Groq API |
| `hooks/usePersonaVoices.ts` | Voice engine | Handles OpenAI TTS |
| `lib/avatarConstants.ts` | Avatar pools | Gender-specific IDs |
| `components/ChromaGrid/` | Visual engine | GSAP animations |

---

## Quick Reference

### Character Roles (20)
empathetic, analytical, provocateur, emotional, calm, assertive, skeptical, optimistic, cynical, nurturing, intense, playful, serious, wise, rebellious, mediator, challenger, supporter, observer, wildcard

### Male Voices (3)
onyx, ash, echo

### Female Voices (5)
alloy, nova, shimmer, sage, coral

### Key Hooks
- `usePerspectives()` - Story generation (Groq)
- `usePersonaVoices()` - Voice management (OpenAI)

### Key Pages
- `LandingPage` - Hero + input (route: `/`)
- `TheatrePage` - Theatre mode (route: `/theatre`)

### Key Components
- `ChromaGrid` - Character grid with spotlight
- `VolumeControl` - Audio volume slider

---

**Last Updated**: November 2024
**License**: [Your License]
